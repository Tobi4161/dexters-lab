<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>LoDash Editor</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.13.1/lodash.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="client.js"></script>
    <script>
      $().ready(function () {
        const loWrapper = new LodashWrapper(_)

        const runScript = () => {
          loWrapper.resetStats()

          $('#result').text('')
          const funcAsString = $('#function').val()

          let data
          try {
            data = JSON.parse($('#data').val())
          } catch (err) {
            $('#result').text(`Invalid data: ${err}`)
            return
          }

          const func = new Function('_', 'data', funcAsString)

          const result = func(loWrapper.lodash, data)

          _.map(loWrapper.stats, (step) => {
            $('#result').append(`\n\nStep ${step.step}. Invoked '${step.funcName}' with args ${step.args}.\n\nResult:\n${step.result}\n`)
          })
          $('#result').append(`\n\nFinal result: \n${JSON.stringify(result, null, 2)}`)
        }

        runScript()

        $('#run-script-btn').on('click', (e) => {
          e.preventDefault()
          runScript()
        })
      })

    </script>
  </head>
  <body>
    <div class="container">

    <div class="row">
      <div class="col-md-6">
        <h4>Data</h4>
        <textarea style='width: 100%' rows='10' id='data'>[{"city": "Rybnik"}, {"city": "Warszawa"}, {"city": "Katowice"}]</textarea>
      </div>
      <div class="col-md-6">
        <h4>Function</h4>
        Lodash instance is available under <pre>_</pre> variable. Provided data is provided with <ore>data</ore> variable.
        <textarea  style='width: 100%' rows='10' id='function'>
          return _(data)
      .map('city')
      .sortBy()
      .value()
        </textarea>
      </div>
    </div>
    <div class='text-center'>
      <a class="btn btn-lg btn-success" href="#" role="button" id='run-script-btn'>Run script</a>
    </div>

    <pre id='result'></pre>

    </div>
  </body>
</html>